---
description: 
globs: 
alwaysApply: true
---
---

description: "Guidelines and guardâ€‘rails for developing OpinionFlow â€“ a realâ€‘time, multiâ€‘store reviewâ€‘analysis agent.  Applies to all source code, docs, and notebook files in this repo."
globs:

* "\*\*/\*.py"
* "\*\*/\*.md"
* "Dockerfile"
* "docker-compose.yml"
* "\*.env.example"
* "data/aspects.yaml"
  alwaysApply: true

---

# ğŸ“¦ Project Context

**Project**: OpinionFlow â€“ realâ€‘time productâ€‘review intelligence powered by Brightâ€¯Data MCP, FastAPI, Streamlit, PGVector, LangChain RAG.
**Goal**: Users enter a product â†’ agent scrapes Amazon/Walmart/Target reviews live â†’ AI summarises sentiment, pros/cons, aspects â†’ UI displays insights & citations.
**Scope (MVP)**: Instant Answer â–¸ Overall Sentiment â–¸ Pros/Cons â–¸ Store Tabs â–¸ Aspect Miniâ€‘Charts â–¸ Source Explorer.

# ğŸ› ï¸ Build Roadâ€‘map (for Cursor)

1. Scaffold folders: `backend/`, `frontend/`, `data/`, `tests/`, `docker/`.
2. FastAPI skeleton `/analyze` POST `{product:str}`.
3. BrightÂ Data client `backend/brightdata.py`: `discover_urls`, `scrape_reviews` (Webâ€¯Unlocker + Playwright click â€œnext pageâ€).
4. Site extractors `backend/extractors/*.py` â†’ `Review` dataclass.
5. Postgres + PGVector: tables `products`, `reviews`.
6. Embeddings: MiniLM via SentenceTransformers.
7. Aspect analysis: YAML map + Gemini prompt.
8. Retrievalâ€‘QA: LangChain + Llamaâ€‘3.
9. Aggregate in `backend/analysis.py`.
10. Streamlit UI `frontend/app.py`.
11. Tests: pytest + fixtures.

# ğŸ—ï¸ Architecture Principles

* Singleâ€‘responsibility modules.
* Async I/O throughout.
* Config via env vars (no hardâ€‘coded secrets).
* Graceful degradation on source failure.
* Every AI answer must cite â‰¥2 review IDs.

# ğŸ Python & Style

* Python 3.11, Black, Ruff, mypyÂ --strict.
* Pydantic for schemas.
* No blocking `requests` in async paths.

# ğŸ•¸ï¸ BrightÂ Data Rules

* Credentials only via env.
* `discover_urls` uses SERP (âœ” Discover).
* `scrape_reviews` uses Webâ€¯Unlocker (âœ” Access), scroll & click (âœ” Interact), parse JSON (âœ” Extract).
* Max 100 reviews per store, 1â€¯s delay per page.

# ğŸ—„ï¸ DB & Vector

```sql
CREATE TABLE products(id serial PRIMARY KEY,name text,last_scraped timestamp);
CREATE TABLE reviews(id bigserial PRIMARY KEY,product_id int REFERENCES products,
                     source text,rating real,text text,embed vector(384));
CREATE INDEX ON reviews USING ivfflat(embed vector_cosine_ops) WITH (lists=100);
```

# ğŸ¤– RAG Rules

* Retriever kâ‰¤6, sim>0.4.
* Prompt templates in `data/prompts/`.
* Aspects YAML maintained via PR.

# ğŸ“ Commits & CI

* Conventional commits.
* Docstring headers required.
* CI: lint, tests, build.

# âš ï¸ Antiâ€‘patterns

* Duplicate CSS selectors across files.
* Storing raw HTML blobs.
* Long blocking loops in request handler.

@README.md
@Dockerfile
@backend/main.py
